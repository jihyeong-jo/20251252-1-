import processing.serial.*;
import processing.net.*;

Serial p;
Server s;
Client c;

// LED ìƒíƒœ (0 ë˜ëŠ” 1)
String ledState = "0";
// ì¡°ë„ ê°’ (0 ~ 1023)
String lightValue = "0";

void setup() {
  size(400, 200);  // ì°½ í¬ê¸°

  // ğŸ”¹ ì•„ë‘ì´ë…¸ ì‹œë¦¬ì–¼ ì„¤ì • (COM í¬íŠ¸ì™€ ì „ì†¡ ì†ë„ë¥¼ ì‚¬ìš© í™˜ê²½ì— ë§ê²Œ í™•ì¸í•´ì£¼ì„¸ìš”!)
  p = new Serial(this, "COM9", 9600);

  // ğŸ”¹ ì•±ì¸ë²¤í„°ìš© ì„œë²„ ì„¤ì • (í¬íŠ¸ 12345)
  s = new Server(this, 12345);

  smooth();
}

void draw() {
  background(0);          
  fill(255);              
  textSize(20);

  // -----------------------------
  // Arduino â†’ Processing (ì‹œë¦¬ì–¼ ìˆ˜ì‹ )
  // -----------------------------
  while (p.available() > 0) {
    String msg = p.readStringUntil('\n');
    if (msg != null) {
      msg = msg.trim();
      
      // ì½˜ì†”ì— ì•„ë‘ì´ë…¸ë¡œë¶€í„° ì˜¨ ë°ì´í„° ì¶œë ¥ (ìƒíƒœ í™•ì¸ìš©)
      println("FROM ARDUINO (RAW): " + msg);

      // LED ìƒíƒœ (0 ë˜ëŠ” 1) ì—…ë°ì´íŠ¸
      if (msg.equals("0") || msg.equals("1")) {
        ledState = msg;
        println("  -> LED STATE UPDATED TO: " + ledState);
      }

      // ì¡°ë„ ê°’ (LIGHT:ìˆ«ì) ì—…ë°ì´íŠ¸
      if (msg.startsWith("LIGHT:")) {
        lightValue = msg.substring(6); 
        println("  -> LIGHT VALUE UPDATED TO: " + lightValue);
      }
    }
  }

  // -----------------------------
  // í™”ë©´ì— ìˆ˜ì¹˜ í‘œì‹œ (Processing ì°½)
  // -----------------------------
  text("LED ìƒíƒœ : " + ledState, 20, 60);      
  text("ì¡°ë„ ê°’ : " + lightValue, 20, 100);    
  text("ì„œë²„ í¬íŠ¸ : 12345", 20, 140);

  // -----------------------------
  // App Inventor â†’ Processing ìˆ˜ì‹ 
  // -----------------------------
  c = s.available();
  if (c != null) {
    String request = c.readString();

    if (request != null) {
      request = request.trim();
      
      // âœ… [í™•ì¸ìš©] ì•±ì¸ë²¤í„°ì—ì„œ ë³´ë‚¸ HTTP ìš”ì²­ ì „ì²´ ì¶œë ¥
      println("-------------------------------------");
      println("FROM APP (HTTP REQUEST):", request);

      // HTTP ìš”ì²­ ë¬¸ìì—´ì—ì„œ ëª…ë ¹ì–´ ê²½ë¡œ(/1 ë˜ëŠ” /0)ë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸
      if (request.contains(" /1 ")) { // LED ì¼œê¸° ëª…ë ¹
        println("âœ… COMMAND RECEIVED: Turn ON (1)");
        p.write('1'); // ì•„ë‘ì´ë…¸ë¡œ '1' ì „ì†¡
        ledState = "1"; // ìƒíƒœ ì„ì‹œ ì—…ë°ì´íŠ¸ (ì‘ë‹µ ì‹œ ì‚¬ìš©)
      } else if (request.contains(" /0 ")) { // LED ë„ê¸° ëª…ë ¹
        println("âœ… COMMAND RECEIVED: Turn OFF (0)");
        p.write('0'); // ì•„ë‘ì´ë…¸ë¡œ '0' ì „ì†¡
        ledState = "0"; // ìƒíƒœ ì„ì‹œ ì—…ë°ì´íŠ¸ (ì‘ë‹µ ì‹œ ì‚¬ìš©)
      } else {
        println("â“ STATUS CHECK/UNKNOWN COMMAND");
      }

      // -----------------------------
      // Processing â†’ App Inventor ì „ì†¡ (ì‘ë‹µ)
      // ì•± ì¸ë²¤í„°ê°€ ê¸°ëŒ€í•˜ëŠ” ledState ê°’ ("1" ë˜ëŠ” "0") ë§Œ ë³´ëƒ„!
      // -----------------------------
      String sendState = ledState; 
      println("SENDING RESPONSE TO APP:", sendState);
      println("-------------------------------------");

      // HTTP ì‘ë‹µ í—¤ë” ì „ì†¡ (200 OK)
      c.write("HTTP/1.1 200 OK\r\n\r\n");
      // ì‘ë‹µ ë°ì´í„° ë³¸ë¬¸ ì „ì†¡
      c.write(sendState); 
    }
    c.stop(); // í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ
  }
}
