int ledPin = 8;
int sensorPin = A0;

bool autoMode = true;        // 자동 제어 모드 상태
bool ledState = false;       // LED 현재 상태

unsigned long manualTime = 0;      // 수동 모드 시작 시간
const unsigned long manualDuration = 30000; // 30초 = 30000ms

// ✅ 조도 기준 임계값 (직접 조절해서 맞추면 됨)
const int lightThreshold = 7;    // 어두움/밝음 기준값

void setup() {
  Serial.begin(9600);
  pinMode(ledPin, OUTPUT);
}

void loop() {
  int sensorValue = analogRead(sensorPin);  // 조도 센서 값 (0~1023)

  // -----------------------------
  // 수동 모드 타이머 체크
  // -----------------------------
  if (!autoMode) {
    // 수동 모드 30초 경과 시 자동 모드로 전환
    if (millis() - manualTime >= manualDuration) {
      autoMode = true;
      Serial.println("AUTO");   // ✅ 자동 모드로 돌아갈 때 표시
    }
  }

  // -----------------------------
  // LED 상태 제어 (자동 모드)
  // -----------------------------
  if (autoMode) {
    // ✅ 자동 모드: 조도 값 기준으로 LED 제어
    // sensorValue가 작을수록 어둡다고 가정 (필요하면 반대로 바꿀 수 있음)
    if (sensorValue <= lightThreshold) {
      ledState = true;   // 어두우면 LED 켜기
    } else {
      ledState = false;  // 밝으면 LED 끄기
    }

    digitalWrite(ledPin, ledState ? HIGH : LOW);

    // ✅ LED 상태를 0 또는 1로 전송 (자동 모드에서도)
    Serial.println(ledState ? 1 : 0);
  }

  // -----------------------------
  // 시리얼 명령 처리 (수동 ON/OFF)
  // -----------------------------
  if (Serial.available() > 0) {
    char cmd = Serial.read();

    if (cmd == '1') {
      autoMode = false;            // 수동 모드
      manualTime = millis();       // 타이머 시작
      ledState = true;             // LED 켜기
      digitalWrite(ledPin, HIGH);
      Serial.println(1);           // ✅ 수동 ON → 1 전송
    }
    else if (cmd == '0') {
      autoMode = false;            // 수동 모드
      manualTime = millis();       // 타이머 시작
      ledState = false;            // LED 끄기
      digitalWrite(ledPin, LOW);
      Serial.println(0);           // ✅ 수동 OFF → 0 전송
    }
  }

  // -----------------------------
  // 조도 값 전송 (analog 값 그대로)
  // -----------------------------
  Serial.print("LIGHT:");
  Serial.println(sensorValue);   // 0 ~ 1023

  delay(200);
}
